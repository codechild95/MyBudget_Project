<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <title>ë‚´ ê°€ê³„ë¶€</title>

    <!-- TailwindCSS -->
    <script src="https://cdn.tailwindcss.com"></script>

    <!-- FullCalendar -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/fullcalendar@6.1.15/main.min.css">
    <script src="https://cdn.jsdelivr.net/npm/fullcalendar@6.1.15/index.global.min.js"></script>

    <!-- Chart.js -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
</head>
<body class="bg-gray-100 min-h-screen">

<div class="max-w-6xl mx-auto p-4 md:p-8">
    <h1 class="text-2xl md:text-3xl font-bold mb-6">ë‚´ ìº˜ë¦°ë” ê°€ê³„ë¶€</h1>

    <!-- ================= ë©”ì¸ ë ˆì´ì•„ì›ƒ (ì¢Œ: ìš”ì•½/Agent, ìš°: ìº˜ë¦°ë”) ================= -->
    <div class="grid grid-cols-1 md:grid-cols-3 gap-6 md:gap-8">

        <!-- ========== ì™¼ìª½ íŒ¨ë„ ========== -->
        <div class="col-span-1 bg-white p-5 md:p-6 rounded-xl shadow flex flex-col h-full">
            <!-- ì´ ìˆ˜ì…/ì§€ì¶œ/ì”ì•¡ -->
            <h2 class="text-xl font-bold mb-4">ìš”ì•½</h2>

            <p class="text-lg">ì´ ìˆ˜ì…:
                <b class="text-green-700">{{ income }}</b> ì›
            </p>
            <p class="text-lg">ì´ ì§€ì¶œ:
                <b class="text-red-700">{{ expense }}</b> ì›
            </p>

            {% set balance = income - expense %}
            <p class="text-lg mt-4">ì”ì•¡:</p>
            {% if balance >= 0 %}
                <b class="text-green-600 text-2xl">{{ balance }} ì›</b>
            {% else %}
                <b class="text-red-600 text-2xl">{{ balance }} ì›</b>
            {% endif %}

            <!-- ì—°ë„ë³„ / ì›”ë³„ ìˆ˜ì…Â·ì§€ì¶œ ìš”ì•½ (ìŠ¤íƒ€ì¼ B: ì—°ë„ ë“œë¡­ë‹¤ìš´) -->
            <div class="mt-6 border-t pt-4">
                <h3 class="text-lg font-bold mb-3">ğŸ“… ì—°ë„ë³„ / ì›”ë³„ ìš”ì•½</h3>

                <div class="flex items-center gap-2 text-sm mb-2">
                    <label for="summary-year" class="text-gray-700">ì—°ë„ ì„ íƒ:</label>
                    <select id="summary-year"
                            class="border rounded px-2 py-1 text-sm">
                        <!-- JSë¡œ ì±„ì›Œì§ -->
                    </select>
                </div>

                <div id="summary-output"
                     class="mt-2 text-xs md:text-sm text-gray-700 bg-gray-50 rounded-lg p-2 max-h-40 overflow-y-auto">
                    ì—°ë„ë¥¼ ì„ íƒí•˜ë©´ ì›”ë³„ ìˆ˜ì…/ì§€ì¶œì´ í‘œì‹œë©ë‹ˆë‹¤.
                </div>
            </div>

            <!-- ê°€ê³„ë¶€ ê²½ì œ Agent -->
            <div class="mt-6 border-t pt-4 flex flex-col flex-1">
                <h3 class="text-lg font-bold mb-2">ğŸ’¬ ê°€ê³„ë¶€ ê²½ì œ Agent</h3>

                <!-- ë©”ì‹œì§€ ì˜ì—­ -->
                <div id="agent-messages"
                     class="border rounded-lg p-3 h-40 md:h-48 overflow-y-auto bg-gray-50 text-sm space-y-2">
                    <div class="text-gray-500 text-xs">
                        ê°€ê³„ë¶€ ë°ì´í„°ë¥¼ ë°”íƒ•ìœ¼ë¡œ ì†Œë¹„ íŒ¨í„´ ë¶„ì„, ì ˆì•½ ë°©í–¥, ì˜ˆì‚° ì¡°ì–¸ì„ ë°›ì„ ìˆ˜ ìˆìŠµë‹ˆë‹¤.<br>
                        ì˜ˆ: "ì´ë²ˆ ë‹¬ ì‹ë¹„ ë§ì´ ì¼ì–´?", "ì–´ë””ì„œ ì¤„ì´ëŠ” ê²Œ ì¢‹ì„ê¹Œ?"
                    </div>
                </div>

                <!-- ì…ë ¥ í¼ -->
                <form id="agent-form" class="mt-3 flex gap-2 text-sm">
                    <input id="agent-input"
                           type="text"
                           class="flex-1 border rounded px-2 py-1"
                           placeholder="ì˜ˆ: ì´ë²ˆ ë‹¬ ì§€ì¶œ íŒ¨í„´ ë¶„ì„í•´ì¤˜">
                    <button type="submit"
                            class="px-3 py-1 bg-blue-600 text-white rounded">
                        ì „ì†¡
                    </button>
                </form>
            </div>
        </div>

        <!-- ========== ì˜¤ë¥¸ìª½: ìº˜ë¦°ë” ========== -->
        <div class="col-span-1 md:col-span-2 bg-white p-4 md:p-6 rounded-xl shadow">
            <h2 class="text-xl font-bold mb-4">ìº˜ë¦°ë”</h2>
            <div id="calendar" class="z-0"></div>
        </div>
    </div>

    <!-- ================= ê·¸ë˜í”„ ì„¹ì…˜ ================= -->

    <!-- 0) ì›”ë³„ ìˆ˜ì…/ì§€ì¶œ ê·¸ë˜í”„ -->
    <div class="mt-8 bg-white p-4 md:p-6 rounded-xl shadow">
        <h2 class="text-xl font-bold mb-4 text-center">ì›”ë³„ í†µê³„ (ìˆ˜ì… vs ì§€ì¶œ)</h2>
        <div class="h-64 md:h-80">
            <canvas id="monthlyChart"></canvas>
        </div>
    </div>

    <!-- 1) ëˆ„ì  ì”ì•¡ ê·¸ë˜í”„ -->
    <div class="mt-8 bg-white p-4 md:p-6 rounded-xl shadow">
        <h2 class="text-xl font-bold mb-4 text-center">ëˆ„ì  ì”ì•¡ ê·¸ë˜í”„</h2>
        <div class="h-64 md:h-80">
            <canvas id="cumulativeChart"></canvas>
        </div>
    </div>

    <!-- 2) ì°¨ìµ ë§‰ëŒ€ ê·¸ë˜í”„ -->
    <div class="mt-8 bg-white p-4 md:p-6 rounded-xl shadow">
        <h2 class="text-xl font-bold mb-4 text-center">ì°¨ìµ (ìˆ˜ì… - ì§€ì¶œ) ê·¸ë˜í”„</h2>
        <div class="h-64 md:h-80">
            <canvas id="profitChart"></canvas>
        </div>
    </div>

    <!-- 3) ì¹´í…Œê³ ë¦¬ë³„ ì§€ì¶œ í†µê³„ (íŒŒì´ ì°¨íŠ¸) -->
    <div class="mt-8 bg-white p-4 md:p-6 rounded-xl shadow">
        <h2 class="text-xl font-bold mb-4 text-center">ì¹´í…Œê³ ë¦¬ë³„ ì§€ì¶œ ë¹„ìœ¨</h2>
        <div class="h-64 md:h-80">
            <canvas id="categoryPieChart"></canvas>
        </div>
    </div>

    <!-- 4) ì§€ì¶œ ìƒìœ„ TOP 5 ì¹´í…Œê³ ë¦¬ -->
    <div class="mt-8 bg-white p-4 md:p-6 rounded-xl shadow">
        <h2 class="text-xl font-bold mb-4 text-center">ì§€ì¶œ ìƒìœ„ TOP 5 ì¹´í…Œê³ ë¦¬</h2>
        <div class="h-64 md:h-80">
            <canvas id="topCategoryChart"></canvas>
        </div>
    </div>

    <!-- 5) ì´ë²ˆ ë‹¬ ëª©í‘œ ëŒ€ë¹„ ì§€ì¶œ í˜„í™© -->
    <div class="mt-8 bg-white p-4 md:p-6 rounded-xl shadow">
        <h2 class="text-xl font-bold mb-4 flex flex-col gap-2 md:flex-row md:justify-between md:items-center">
            <span>ì´ë²ˆ ë‹¬ ëª©í‘œ ëŒ€ë¹„ ì§€ì¶œ í˜„í™©</span>

            <div class="flex items-center gap-2 text-sm">
                <label>ëª©í‘œ ì§€ì¶œ: </label>
                <input id="monthlyGoalInput"
                       type="number"
                       class="border p-1 rounded w-28 text-right"
                       placeholder="ì˜ˆ: 1000000">
                <button onclick="updateMonthlyGoal()"
                        class="px-3 py-1 bg-blue-600 text-white rounded">
                    ì ìš©
                </button>
            </div>
        </h2>

        <!-- Progress bar -->
        <div class="mt-4 w-full bg-gray-200 rounded-full h-4">
            <div id="goalProgressBar"
                 class="bg-blue-500 h-4 rounded-full"
                 style="width: 0%;"></div>
        </div>

        <!-- ê°’ í‘œì‹œ -->
        <p class="mt-2 text-sm text-gray-600 text-center md:text-left">
            <span id="currentExpenseValue">í˜„ì¬ ì§€ì¶œ: 0ì›</span> /
            <span id="goalValue">ëª©í‘œ ì§€ì¶œ: 0ì›</span>
        </p>

        <!-- ë§‰ëŒ€ ì°¨íŠ¸ -->
        <div class="mt-4 h-64 md:h-80">
            <canvas id="goalChart"></canvas>
        </div>
    </div>
</div>

<!-- ================= ëª¨ë‹¬: ìˆ˜ì…/ì§€ì¶œ ì…ë ¥ + í•´ë‹¹ ë‚ ì§œ ë‚´ì—­ ================= -->
<div id="modal"
     class="fixed inset-0 bg-black bg-opacity-40 flex items-center justify-center hidden z-50">
    <div class="bg-white p-5 md:p-6 rounded-xl shadow-xl w-11/12 max-w-md relative">
        <h3 class="text-lg font-bold mb-2">ìˆ˜ì… / ì§€ì¶œ ì…ë ¥</h3>
        <p class="mb-3 text-gray-600 text-sm" id="modal-date-text"></p>

        <form id="dataForm" method="post" action="/add" class="space-y-3">
            <input type="hidden" name="date" id="modal-date">

            <!-- ìœ í˜• -->
            <div>
                <label class="block text-sm mb-1">ìœ í˜•</label>
                <select name="type" class="border rounded p-2 w-full text-sm">
                    <option value="income">ìˆ˜ì…</option>
                    <option value="expense">ì§€ì¶œ</option>
                </select>
            </div>

            <!-- ì¹´í…Œê³ ë¦¬ -->
            <div>
                <label class="block text-sm mb-1">ì¹´í…Œê³ ë¦¬</label>
                <select name="category" class="border rounded p-2 w-full text-sm text-center">
                    <option value="ì›”ê¸‰">ì›”ê¸‰</option>
                    <option value="ì‹ë¹„">ì‹ë¹„</option>
                    <option value="êµí†µ">êµí†µ</option>
                    <option value="ì£¼ê±°">ì£¼ê±°</option>
                    <option value="ì·¨ë¯¸">ì·¨ë¯¸</option>
                    <option value="ê¸°íƒ€" selected>ê¸°íƒ€</option>
                </select>
            </div>

            <!-- í•­ëª© ì´ë¦„ -->
            <div>
                <label class="block text-sm mb-1">í•­ëª© ì´ë¦„</label>
                <input type="text" name="title"
                       class="border rounded p-2 w-full text-sm"
                       placeholder="ì˜ˆ: ì ì‹¬ ì‹ì‚¬" required>
            </div>

            <!-- ê¸ˆì•¡ -->
            <div>
                <label class="block text-sm mb-1">ê¸ˆì•¡</label>
                <input type="number" name="amount"
                       class="border rounded p-2 w-full text-sm"
                       placeholder="ì˜ˆ: 12000" required>
            </div>

            <!-- ë²„íŠ¼ -->
            <div class="flex justify-end gap-2 pt-2">
                <button type="button"
                        onclick="closeModal()"
                        class="px-3 py-1 rounded bg-gray-300 text-sm">
                    ì·¨ì†Œ
                </button>
                <button type="submit"
                        class="px-3 py-1 rounded bg-blue-600 text-white text-sm">
                    ì €ì¥
                </button>
            </div>
        </form>

        <!-- í•´ë‹¹ ë‚ ì§œì˜ ë‚´ì—­ ë¦¬ìŠ¤íŠ¸ -->
        <div class="mt-4 border-t pt-3 max-h-48 overflow-y-auto text-sm">
            <h4 class="font-semibold mb-2">í•´ë‹¹ ë‚ ì§œ ë‚´ì—­</h4>
            <div id="record-list" class="space-y-1 text-xs md:text-sm text-gray-700">
                <!-- JSë¡œ ì±„ì›Œì§ -->
            </div>
        </div>
    </div>
</div>

<script>
let calendar;
let selectedDate;

let monthlyChart, cumulativeChart, profitChart;
let categoryPieChart, topCategoryChart, goalChart;
let monthlyGoal = 0;

let monthlyStatsCache = [];   // /stats/monthly ê²°ê³¼
let agentHistory = [];

// ================= ëª¨ë‹¬ ì œì–´ =================
function openModal(dateStr) {
    selectedDate = dateStr;
    document.getElementById("modal-date").value = dateStr;
    document.getElementById("modal-date-text").innerText = "ì„ íƒí•œ ë‚ ì§œ: " + dateStr;
    document.getElementById("modal").classList.remove("hidden");
    loadRecordsForDate(dateStr);
}

function closeModal() {
    document.getElementById("modal").classList.add("hidden");
}

// ================= ë‚ ì§œë³„ ë‚´ì—­ ë¡œë”© + ì‚­ì œ ë²„íŠ¼ =================
async function loadRecordsForDate(dateStr) {
    try {
        const res = await fetch(`/records?date=${encodeURIComponent(dateStr)}`);
        const data = await res.json();
        const listEl = document.getElementById("record-list");
        listEl.innerHTML = "";

        if (!data || data.length === 0) {
            listEl.innerHTML = "<p class='text-gray-400'>ë‚´ì—­ì´ ì—†ìŠµë‹ˆë‹¤.</p>";
            return;
        }

        data.forEach(r => {
            const sign = r.type === "income" ? "+" : "-";
            const color = r.type === "income" ? "text-green-700" : "text-red-700";

            const row = document.createElement("div");
            row.className = "flex justify-between items-center";

            row.innerHTML = `
                <div class="flex-1">
                    <span class="${color} font-semibold">${sign}${Number(r.amount).toLocaleString()}ì›</span>
                    <span class="ml-2">${r.title}</span>
                    <span class="ml-1 text-gray-400">(${r.category || "ì¹´í…Œê³ ë¦¬ ì—†ìŒ"})</span>
                </div>
                <button
                    class="ml-2 px-2 py-1 text-xs bg-red-500 text-white rounded"
                    onclick="deleteRecord(${r.id}, '${dateStr}')">
                    ì‚­ì œ
                </button>
            `;
            listEl.appendChild(row);
        });
    } catch (e) {
        console.error(e);
    }
}

async function deleteRecord(recordId, dateStr) {
    if (!confirm("ì´ ë‚´ì—­ì„ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?")) return;

    try {
        const res = await fetch(`/records/${recordId}`, { method: "DELETE" });
        if (!res.ok) {
            alert("ì‚­ì œ ì‹¤íŒ¨");
            return;
        }

        // ëª¨ë‹¬ ë‚´ ëª©ë¡ ê°±ì‹  + ë‹¬ë ¥ / ì°¨íŠ¸ ê°±ì‹ 
        await loadRecordsForDate(dateStr);
        await loadCalendarEvents();
        await loadMonthlyChart();
        await loadCategoryPieChart();
        await loadTopCategoryChart();
        await loadGoalChart();
    } catch (e) {
        console.error(e);
        alert("ì‚­ì œ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.");
    }
}

// ================= ìº˜ë¦°ë” ë‚ ì§œë³„ í•©ê³„ í‘œì‹œ =================
async function loadCalendarEvents() {
    try {
        const res = await fetch("/records/all");
        const data = await res.json();

        const map = {}; // {date: {income, expense}}
        data.forEach(r => {
            if (!map[r.date]) map[r.date] = {income: 0, expense: 0};
            if (r.type === "income") map[r.date].income += Number(r.amount);
            else if (r.type === "expense") map[r.date].expense += Number(r.amount);
        });

        const events = Object.keys(map).map(date => {
            const income = map[date].income;
            const expense = map[date].expense;
            const net = income - expense;

            const titleParts = [];
            if (income > 0) titleParts.push(`+${income.toLocaleString()}ì›`);
            if (expense > 0) titleParts.push(`-${expense.toLocaleString()}ì›`);

            return {
                title: titleParts.join(" / "),
                start: date,
                allDay: true,
                display: "block",
                backgroundColor: net >= 0 ? "#bbf7d0" : "#fecaca",
                borderColor: net >= 0 ? "#16a34a" : "#dc2626"
            };
        });

        calendar.removeAllEvents();
        calendar.addEventSource(events);
    } catch (e) {
        console.error(e);
    }
}

// ================= ì›”ë³„ í†µê³„ + ì°¨íŠ¸ë“¤ =================
async function loadMonthlyChart() {
    try {
        const res = await fetch("/stats/monthly");
        const data = await res.json();
        monthlyStatsCache = data || [];

        const labels = data.map(d => d.month);
        const incomes = data.map(d => d.income || 0);
        const expenses = data.map(d => d.expense || 0);

        const ctx = document.getElementById("monthlyChart").getContext("2d");
        if (monthlyChart) monthlyChart.destroy();

        monthlyChart = new Chart(ctx, {
            type: "bar",
            data: {
                labels,
                datasets: [
                    {
                        label: "ìˆ˜ì…",
                        data: incomes,
                        backgroundColor: "rgba(34, 197, 94, 0.6)"
                    },
                    {
                        label: "ì§€ì¶œ",
                        data: expenses,
                        backgroundColor: "rgba(248, 113, 113, 0.7)"
                    }
                ]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                scales: {
                    y: {
                        beginAtZero: true,
                        ticks: {
                            callback: v => v.toLocaleString() + "ì›"
                        }
                    }
                }
            }
        });

        // ëˆ„ì  ì”ì•¡ / ì°¨ìµ ê·¸ë˜í”„ë„ ë™ì¼ ë°ì´í„°ë¡œ ê³„ì‚°
        loadCumulativeChartFrom(data);
        loadProfitChartFrom(data);
        // ì—°ë„ ì„ íƒ UI ê°±ì‹ 
        populateYearSelect(data);
    } catch (e) {
        console.error(e);
    }
}

function loadCumulativeChartFrom(data) {
    const labels = data.map(d => d.month);
    const incomes = data.map(d => d.income || 0);
    const expenses = data.map(d => d.expense || 0);

    const cumulative = [];
    let balance = 0;
    for (let i = 0; i < labels.length; i++) {
        balance += incomes[i] - expenses[i];
        cumulative.push(balance);
    }

    const ctx = document.getElementById("cumulativeChart").getContext("2d");
    if (cumulativeChart) cumulativeChart.destroy();

    cumulativeChart = new Chart(ctx, {
        type: "line",
        data: {
            labels,
            datasets: [{
                label: "ëˆ„ì  ì”ì•¡",
                data: cumulative,
                borderColor: "rgba(59,130,246,1)",
                backgroundColor: "rgba(59,130,246,0.3)",
                fill: true,
                tension: 0.25,
                borderWidth: 3
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false
        }
    });
}

function loadProfitChartFrom(data) {
    const labels = data.map(d => d.month);
    const profits = data.map(d => (d.income || 0) - (d.expense || 0));
    const colors = profits.map(v => v >= 0 ? "rgba(34,197,94,0.7)" : "rgba(248,113,113,0.7)");

    const ctx = document.getElementById("profitChart").getContext("2d");
    if (profitChart) profitChart.destroy();

    profitChart = new Chart(ctx, {
        type: "bar",
        data: {
            labels,
            datasets: [{
                label: "ì°¨ìµ (ìˆ˜ì… - ì§€ì¶œ)",
                data: profits,
                backgroundColor: colors
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false
        }
    });
}

// ================= ì¹´í…Œê³ ë¦¬ ì°¨íŠ¸ =================
async function loadCategoryPieChart() {
    try {
        const res = await fetch("/stats/categories");
        const data = await res.json();

        const labels = data.map(d => d.category);
        const totals = data.map(d => d.total);

        const ctx = document.getElementById("categoryPieChart").getContext("2d");
        if (categoryPieChart) categoryPieChart.destroy();

        categoryPieChart = new Chart(ctx, {
            type: "pie",
            data: {
                labels,
                datasets: [{
                    data: totals,
                    backgroundColor: [
                        "#60a5fa", "#34d399", "#f87171",
                        "#fbbf24", "#a78bfa", "#f472b6"
                    ]
                }]
            },
            options: { responsive: true, maintainAspectRatio: false }
        });
    } catch (e) {
        console.error(e);
    }
}

async function loadTopCategoryChart() {
    try {
        const res = await fetch("/stats/categories");
        const data = await res.json();

        const sorted = data.sort((a, b) => b.total - a.total).slice(0, 5);
        const labels = sorted.map(d => d.category);
        const totals = sorted.map(d => d.total);

        const ctx = document.getElementById("topCategoryChart").getContext("2d");
        if (topCategoryChart) topCategoryChart.destroy();

        topCategoryChart = new Chart(ctx, {
            type: "bar",
            data: {
                labels,
                datasets: [{
                    label: "ì§€ì¶œ ê¸ˆì•¡",
                    data: totals,
                    backgroundColor: "rgba(248,113,113,0.7)"
                }]
            },
            options: { responsive: true, maintainAspectRatio: false }
        });
    } catch (e) {
        console.error(e);
    }
}

// ================= ëª©í‘œ ëŒ€ë¹„ ì‹¤ì  =================
function updateMonthlyGoal() {
    const v = document.getElementById("monthlyGoalInput").value.trim();
    if (!v || isNaN(v)) return;
    monthlyGoal = Number(v);
    document.getElementById("goalValue").innerText =
        `ëª©í‘œ ì§€ì¶œ: ${monthlyGoal.toLocaleString()}ì›`;
    loadGoalChart();
}

async function loadGoalChart() {
    try {
        const res = await fetch("/stats/current_month");
        const data = await res.json();
        const totalExpense = data.total_expense || 0;

        document.getElementById("currentExpenseValue").innerText =
            `í˜„ì¬ ì§€ì¶œ: ${totalExpense.toLocaleString()}ì›`;

        let ratio = 0;
        if (monthlyGoal > 0) {
            ratio = Math.min((totalExpense / monthlyGoal) * 100, 100);
        }
        document.getElementById("goalProgressBar").style.width = ratio + "%";

        const ctx = document.getElementById("goalChart").getContext("2d");
        if (goalChart) goalChart.destroy();

        goalChart = new Chart(ctx, {
            type: "bar",
            data: {
                labels: ["ëª©í‘œ ì§€ì¶œ", "í˜„ì¬ ì§€ì¶œ"],
                datasets: [{
                    data: [monthlyGoal, totalExpense],
                    backgroundColor: [
                        "rgba(96,165,250,0.7)",
                        "rgba(239,68,68,0.7)"
                    ]
                }]
            },
            options: { responsive: true, maintainAspectRatio: false }
        });
    } catch (e) {
        console.error(e);
    }
}

// ================= ì—°ë„ë³„ / ì›”ë³„ ìš”ì•½ (Bì•ˆ) =================
function populateYearSelect(data) {
    const select = document.getElementById("summary-year");
    if (!select) return;

    const years = new Set();
    data.forEach(d => {
        if (d.month && d.month.length >= 4) {
            years.add(d.month.substring(0, 4));  // "YYYY"
        }
    });

    const yearArray = Array.from(years).sort();  // ì˜¤ë¦„ì°¨ìˆœ
    select.innerHTML = "";

    if (yearArray.length === 0) {
        const opt = document.createElement("option");
        opt.value = "";
        opt.textContent = "ë°ì´í„° ì—†ìŒ";
        select.appendChild(opt);
        document.getElementById("summary-output").innerText = "ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤.";
        return;
    }

    yearArray.forEach(y => {
        const opt = document.createElement("option");
        opt.value = y;
        opt.textContent = y + "ë…„";
        select.appendChild(opt);
    });

    // ê°€ì¥ ìµœê·¼ ì—°ë„ ìë™ ì„ íƒ
    select.value = yearArray[yearArray.length - 1];
    renderYearSummary(select.value);

    select.onchange = () => {
        renderYearSummary(select.value);
    };
}

function renderYearSummary(year) {
    const out = document.getElementById("summary-output");
    if (!out || !year) {
        out.innerText = "ì—°ë„ë¥¼ ì„ íƒí•˜ë©´ ì›”ë³„ ìˆ˜ì…/ì§€ì¶œì´ í‘œì‹œë©ë‹ˆë‹¤.";
        return;
    }

    const filtered = monthlyStatsCache.filter(d => d.month.startsWith(year));
    if (filtered.length === 0) {
        out.innerText = "ì„ íƒí•œ ì—°ë„ì— ëŒ€í•œ ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤.";
        return;
    }

    let totalIncome = 0;
    let totalExpense = 0;

    filtered.forEach(d => {
        totalIncome += d.income || 0;
        totalExpense += d.expense || 0;
    });

    const net = totalIncome - totalExpense;

    let html = `
        <div class="mb-2 font-semibold text-gray-800">
            ${year}ë…„ ì´ ìˆ˜ì…: ${totalIncome.toLocaleString()}ì› /
            ì´ ì§€ì¶œ: ${totalExpense.toLocaleString()}ì› /
            ì”ì•¡: <span class="${net >= 0 ? "text-green-600" : "text-red-600"}">
                ${net.toLocaleString()}ì›
            </span>
        </div>
        <table class="w-full text-xs md:text-sm text-center">
            <thead>
                <tr class="border-b">
                    <th class="py-1">ì›”</th>
                    <th class="py-1">ìˆ˜ì…</th>
                    <th class="py-1">ì§€ì¶œ</th>
                    <th class="py-1">ì°¨ìµ</th>
                </tr>
            </thead>
            <tbody>
    `;

    filtered.forEach(d => {
        const [y, m] = d.month.split("-");
        const inc = d.income || 0;
        const exp = d.expense || 0;
        const diff = inc - exp;
        html += `
            <tr class="border-b last:border-0">
                <td class="py-1">${Number(m)}ì›”</td>
                <td class="py-1 text-green-700">${inc.toLocaleString()}ì›</td>
                <td class="py-1 text-red-700">${exp.toLocaleString()}ì›</td>
                <td class="py-1 ${diff >= 0 ? "text-green-600" : "text-red-600"}">
                    ${diff.toLocaleString()}ì›
                </td>
            </tr>
        `;
    });

    html += `
            </tbody>
        </table>
    `;

    out.innerHTML = html;
}

// ================= Agent í”„ë¡ íŠ¸ =================
function setupAgent() {
    const agentForm = document.getElementById("agent-form");
    const agentInput = document.getElementById("agent-input");
    const agentMessages = document.getElementById("agent-messages");

    if (!agentForm || !agentInput || !agentMessages) return;

    function appendAgentMessage(role, text) {
        const div = document.createElement("div");

        if (role === "user") {
            div.className = "text-right";
            div.innerHTML = `
                <div class="inline-block bg-blue-500 text-white px-2 py-1 rounded-lg text-xs md:text-sm">
                    ${text}
                </div>
            `;
        } else {
            div.className = "text-left";
            div.innerHTML = `
                <div class="inline-block bg-white border px-2 py-1 rounded-lg text-xs md:text-sm">
                    ${text.replace(/\n/g, "<br>")}
                </div>
            `;
        }

        agentMessages.appendChild(div);
        agentMessages.scrollTop = agentMessages.scrollHeight;
    }

    agentForm.addEventListener("submit", async (e) => {
        e.preventDefault();
        const msg = agentInput.value.trim();
        if (!msg) return;

        appendAgentMessage("user", msg);
        agentHistory.push({ role: "user", content: msg });
        agentInput.value = "";
        agentInput.disabled = true;

        try {
            const res = await fetch("/agent/chat", {
                method: "POST",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify({
                    message: msg,
                    history: agentHistory
                })
            });

            const data = await res.json();
            const reply = data.reply || "(ì‘ë‹µì„ ê°€ì ¸ì˜¤ì§€ ëª»í–ˆì–´ìš”.)";

            appendAgentMessage("assistant", reply);
            agentHistory.push({ role: "assistant", content: reply });
        } catch (err) {
            console.error(err);
            appendAgentMessage("assistant", "ì„œë²„ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆì–´ìš”. ì ì‹œ í›„ ë‹¤ì‹œ ì‹œë„í•´ì¤˜.");
        } finally {
            agentInput.disabled = false;
            agentInput.focus();
        }
    });
}

// ================= ì´ˆê¸°í™” =================
document.addEventListener("DOMContentLoaded", function () {
    // ìº˜ë¦°ë” ì´ˆê¸°í™”
    const calendarEl = document.getElementById("calendar");
    calendar = new FullCalendar.Calendar(calendarEl, {
        initialView: "dayGridMonth",
        height: 600,
        locale: "ko",
        headerToolbar: {
            left: "prev,next today",
            center: "title",
            right: ""
        },
        dateClick: function (info) {
            openModal(info.dateStr);
        }
    });
    calendar.render();

    // Agent ì„¤ì •
    setupAgent();

    // ë°ì´í„° ë¡œë”©
    loadCalendarEvents();
    loadMonthlyChart();
    loadCategoryPieChart();
    loadTopCategoryChart();
    loadGoalChart();
});
</script>

</body>
</html>
